import React, { useState, useEffect } from 'react'
import styled from 'styled-components'
import ExpenseForm from '../Form/ExpenseForm'
import ExpenseCard from '../ExpenseCard/ExpenseCard'
import GeneratedTips from '../DashboardGraphics/GeneratedTips'

const Expense = ({ userId }) => {
    const [expenses, setExpenses] = useState([])

    // Fetch incomes when component mounts
    useEffect(() => {
        if(userId){
        fetchExpenses()
    }
    }, [userId])

    // Function to fetch incomes
    const fetchExpenses = async () => {
        try {
            const response = await fetch(`https://budgeme.onrender.com/api/v1/get-expenses/${userId}`)
            if (!response.ok) {
                throw new Error("Failed to fetch income data")
            }
            const data = await response.json();
            setExpenses(data);
        } catch (error) {
            console.log('Error fetching expenses:', error)
        }
    }

    // Function to add new income to the list dynamically
    const handleNewExpense = async (newExpense) => {
        try {
            const response = await fetch('https://budgeme.onrender.com/api/v1/add-expense', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({...newExpense, userId}),
            });

            const responseData = await response.json()
            console.log("Response Received:", responseData)

            if (!response.ok) {
                throw new Error(responseData.message || "Failed to add Expense");
            }

            // If successful, refetch expense
            fetchExpenses();
        } catch (error) {
            console.log('Error adding expense:', error);
        }
    }


    const handleDeleteExpense = async (expenseId) => {
        try {
            const response = await fetch(`https://budgeme.onrender.com/api/v1/delete-expense/${expenseId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
            });
    
            if (!response.ok) {
                throw new Error("Failed to delete expense");
            }
    
            // Only update state using setExpenses inside the component
            setExpenses((prevExpenses) => prevExpenses.filter(expense => expense._id !== expenseId));
    
        } catch (error) {
            console.log('Error deleting expense:', error);
        }
    };

    const handleEditExpense = async (expenseId, updatedExpense) => {
        try {
            const correctedExpense ={
                ...updatedExpense,
                date: new Date(updatedExpense.date).toISOString().split("T")[0] + "T00:00:00.000Z"
            }

            const response = await fetch(`https://budgeme.onrender.com/api/v1/update-expense/${expenseId}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(correctedExpense)
            })

            if(!response.ok) { 
                throw new Error("Failed to update Expense");
            }

            const updatedExpenseData = await response.json()

            setExpenses(prevExpenses =>
                prevExpenses.map(expense =>
                    expense._id === expenseId ? updatedExpenseData.expense : expense
                )
            )
        } catch (error) {
            console.log("Error updating income:", error)
        }
    }
    

    return (
        
        <ExpenseStyled>
            <div className="container">
                <div className="form">
                    <ExpenseForm onNewExpense={handleNewExpense} />
                </div>
                <div className="tips">
                    <GeneratedTips userId={userId} />
                </div>
            </div>
            <ExpenseCard expenses={expenses} onDeleteExpense={handleDeleteExpense} onEditExpense={handleEditExpense}/>
        </ExpenseStyled>
    )
}

const ExpenseStyled = styled.div`
@media screen and (min-width: 786px){
    .container{ 
    display:flex;
    width: 100%;
    }

    .form{
        width: 50%;
        
    }
    .tips{
        width: 50%;
        padding: 1rem;
    }
}

@media screen and (max-width: 786px){
    .tips{ 
        padding: 1rem;
    }

}
`

export default Expense
